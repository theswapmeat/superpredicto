{% extends "base.html" %} {% block content %}

<h3 class="text-center mb-4">Submit Your Picks</h3>

<form method="POST" id="picks-form">
  <div class="table-responsive">
    <table
      class="table table-bordered table-hover align-middle text-nowrap schedule-table"
    >
      <thead class="table-dark text-center">
        <tr>
          <th class="d-none d-md-table-cell">Game #</th>
          <th>Date</th>
          <th class="d-none d-md-table-cell">Time</th>
          <th>Home Team</th>
          <th style="width: 70px">Score</th>
          <th>Away Team</th>
        </tr>
      </thead>
      <tbody>
        {% for game in games %} {% set editable = game.date_of_game >
        uae_now.date() or (game.date_of_game == uae_now.date() and
        game.time_of_game > uae_now.time()) %} {% set prediction =
        pred_dict.get(game.id) %} {% set home_key = 'home_score_' ~ game.id %}
        {% set away_key = 'away_score_' ~ game.id %} {% set error = form_data
        and ((form_data.get(home_key) and not form_data.get(away_key)) or
        (form_data.get(away_key) and not form_data.get(home_key))) %} {% set
        is_invalid = form_data.get('invalid_' ~ game.id) %}

        <tr
          class="text-center {% if prediction %}table-success{% endif %} {% if error or is_invalid %}table-danger{% endif %}"
        >
          <td class="d-none d-md-table-cell">
            {% if not editable %}
            <img
              src="{{ url_for('static', filename='icons/lock-alt-svgrepo-com.svg') }}"
              alt="Locked"
              title="Locked."
              style="
                width: 18px;
                height: 18px;
                vertical-align: middle;
                margin-right: 4px;
                filter: brightness(0) saturate(100%) invert(9%) sepia(91%)
                  saturate(7417%) hue-rotate(249deg) brightness(90%)
                  contrast(110%);
              "
            />
            {% endif %} {{ game.game_number }}
          </td>
          <td>{{ game.date_of_game.strftime('%B %d, %Y') }}</td>
          <td class="d-none d-md-table-cell">
            {{ game.time_of_game.strftime('%H:%M') }}
          </td>
          <td>{{ game.home_team }}</td>
          <td>
            {% if editable %}
            <div class="d-flex justify-content-between">
              <input
                type="number"
                name="{{ home_key }}"
                value="{% if form_data %}{{ form_data.get(home_key, '') }}{% else %}{{ prediction.home_score_prediction if prediction else '' }}{% endif %}"
                class="form-control text-center me-1 score-input"
                min="0"
                step="1"
                inputmode="numeric"
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                style="
                  width: 40px;
                  font-size: 0.85rem;
                  appearance: textfield;
                  -moz-appearance: textfield;
                "
              />
              <span class="align-self-center">-&nbsp;</span>
              <input
                type="number"
                name="{{ away_key }}"
                value="{% if form_data %}{{ form_data.get(away_key, '') }}{% else %}{{ prediction.away_score_prediction if prediction else '' }}{% endif %}"
                class="form-control text-center me-1 score-input"
                min="0"
                step="1"
                inputmode="numeric"
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                style="
                  width: 40px;
                  font-size: 0.85rem;
                  appearance: textfield;
                  -moz-appearance: textfield;
                "
              />
            </div>
            {% if error %}
            <div class="text-danger small mt-1">
              Please enter both scores or leave both blank.
            </div>
            {% endif %} {% else %} {% if prediction %}
            <span class="score-text"
              >{{ prediction.home_score_prediction }}</span
            >
            <span class="score-text">-</span>
            <span class="score-text"
              >{{ prediction.away_score_prediction }}</span
            >
            {% else %}
            <span class="score-text">-</span>
            {% endif %} {% endif %}
          </td>
          <td>{{ game.away_team }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end mt-3">
    <button type="submit" class="btn btn-success" id="submit-button" disabled>
      Save Picks
    </button>
  </div>
</form>

<style>
  @media (max-width: 576px) {
    .schedule-table td,
    .schedule-table th {
      font-size: 12px;
      padding: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Set specific column widths for mobile */
    .schedule-table td:nth-child(2),
    .schedule-table th:nth-child(2) {
      width: 20% !important; /* Date */
    }

    .schedule-table td:nth-child(4),
    .schedule-table th:nth-child(4) {
      width: 30% !important; /* Home Team */
      max-width: 100px;
    }

    .schedule-table td:nth-child(5),
    .schedule-table th:nth-child(5) {
      width: 20% !important; /* Score */
    }

    .schedule-table td:nth-child(6),
    .schedule-table th:nth-child(6) {
      width: 30% !important; /* Away Team */
      max-width: 100px;
    }

    /* Prevent horizontal scroll */
    .table-responsive {
      overflow-x: hidden;
    }

    /* Optional: show full team name on hover */
    .schedule-table td:nth-child(4):hover,
    .schedule-table td:nth-child(6):hover {
      white-space: normal;
      overflow: visible;
      position: relative;
      z-index: 1;
      background-color: #fff;
    }
  }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .form-control {
    padding: 0.2rem 0.3rem;
  }

  .table-danger input {
    border-color: #dc3545;
    background-color: #f8d7da;
  }

  .table-success input:disabled {
    background-color: #e9fbe9;
  }

  /* Fix spacing around dash in non-editable score display */
  td:nth-child(5):not(:has(input)) {
    font-size: 0.9rem;
    padding-left: 0.25rem;
    padding-right: 0.25rem;
  }

  .score-text {
    display: inline-block;
    margin: 0 2px;
  }
</style>

<script>
  function validatePicksForm() {
    const rows = document.querySelectorAll(".score-input");
    const submitButton = document.getElementById("submit-button");

    let allRowsValid = true;
    let hasAtLeastOnePick = false;

    const groupedRows = {};

    rows.forEach((input) => {
      const nameParts = input.name.split("_");
      const gameId = nameParts[nameParts.length - 1];

      if (!groupedRows[gameId])
        groupedRows[gameId] = { home: null, away: null };

      if (nameParts[0] === "home")
        groupedRows[gameId].home = input.value.trim();
      if (nameParts[0] === "away")
        groupedRows[gameId].away = input.value.trim();
    });

    for (const gameId in groupedRows) {
      const { home, away } = groupedRows[gameId];
      const hasHome = home !== "";
      const hasAway = away !== "";

      if ((hasHome && !hasAway) || (!hasHome && hasAway)) {
        allRowsValid = false;
        break;
      }

      if (hasHome && hasAway) hasAtLeastOnePick = true;
    }

    submitButton.disabled = !(allRowsValid && hasAtLeastOnePick);
  }

  document.querySelectorAll(".score-input").forEach((input) => {
    input.addEventListener("input", validatePicksForm);
  });

  window.addEventListener("DOMContentLoaded", validatePicksForm);
</script>

{% endblock %}
